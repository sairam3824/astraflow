<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Search - AstraFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col">
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white font-semibold">
                        U
                    </div>
                    <div>
                        <div class="font-semibold text-gray-900">User</div>
                        <div class="text-xs text-gray-500">Admin</div>
                    </div>
                </div>
            </div>

            <nav class="flex-1 p-4 space-y-1">
                <a href="/" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-50">
                    <span>üè†</span>
                    <span>Home</span>
                </a>
                <a href="/collections" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-50">
                    <span>üìã</span>
                    <span>Collections</span>
                </a>
                <a href="/rag" class="flex items-center space-x-3 px-3 py-2 rounded-lg bg-gray-100 text-gray-900 font-medium">
                    <span>üîç</span>
                    <span>RAG Search</span>
                </a>
                <a href="/chat" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-50">
                    <span>üí¨</span>
                    <span>Chat</span>
                </a>
                <a href="/workflows" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-50">
                    <span>‚öôÔ∏è</span>
                    <span>Workflows</span>
                </a>
                <a href="/stocks" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-50">
                    <span>üìà</span>
                    <span>Stock Analysis</span>
                </a>
                <a href="/github" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-50">
                    <span>üêô</span>
                    <span>GitHub Analysis</span>
                </a>
            </nav>

            <div class="p-4 border-t border-gray-200">
                <button onclick="logout()" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-50 w-full">
                    <span>üö™</span>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <div class="p-8">
                <div class="max-w-4xl mx-auto">
                    <!-- Header -->
                    <div class="mb-8">
                        <h1 class="text-3xl font-bold text-gray-900 mb-2">üîç RAG Search</h1>
                        <p class="text-gray-500">Search your documents with AI-powered semantic search</p>
                    </div>

                    <!-- Collection Selector -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Collection</label>
                        <select id="collectionSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">Loading collections...</option>
                        </select>
                    </div>

                    <!-- Search Box -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                id="searchQuery" 
                                placeholder="Ask a question about your documents..." 
                                class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                onkeypress="if(event.key === 'Enter') performSearch()"
                            />
                            <button 
                                onclick="performSearch()" 
                                class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium"
                            >
                                Search
                            </button>
                        </div>
                        <div class="mt-3 flex items-center gap-4 text-sm text-gray-500">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="useRAG" checked class="rounded">
                                <span>Use RAG (AI-generated answer)</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <span>Top K:</span>
                                <input type="number" id="topK" value="5" min="1" max="20" class="w-16 px-2 py-1 border border-gray-300 rounded">
                            </label>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div id="loadingState" class="hidden bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
                        <p class="text-gray-500">Searching your documents...</p>
                    </div>

                    <!-- Results Container -->
                    <div id="resultsContainer"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let collections = [];

        // Load collections
        async function loadCollections() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('http://localhost:8000/collections', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                collections = await response.json();
                
                const select = document.getElementById('collectionSelect');
                if (collections.length === 0) {
                    select.innerHTML = '<option value="">No collections available</option>';
                } else {
                    select.innerHTML = '<option value="">Select a collection...</option>' +
                        collections.map(col => `<option value="${col.id}">${col.name}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading collections:', error);
            }
        }

        // Perform search
        async function performSearch() {
            const collectionId = document.getElementById('collectionSelect').value;
            const query = document.getElementById('searchQuery').value.trim();
            const useRAG = document.getElementById('useRAG').checked;
            const topK = parseInt(document.getElementById('topK').value);

            if (!collectionId) {
                alert('Please select a collection');
                return;
            }

            if (!query) {
                alert('Please enter a search query');
                return;
            }

            // Show loading
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('resultsContainer').innerHTML = '';

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`http://localhost:8000/collections/${collectionId}/search?query=${encodeURIComponent(query)}&top_k=${topK}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                
                // Hide loading
                document.getElementById('loadingState').classList.add('hidden');

                // Display results
                displayResults(data, useRAG);
            } catch (error) {
                console.error('Error performing search:', error);
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('resultsContainer').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
                        <p class="text-red-600">Error performing search. Please try again.</p>
                    </div>
                `;
            }
        }

        function displayResults(data, useRAG) {
            const container = document.getElementById('resultsContainer');
            
            let html = '';

            // AI Answer (if RAG is enabled)
            if (useRAG && data.answer) {
                html += `
                    <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl shadow-sm border border-purple-200 p-6 mb-6">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-2xl">ü§ñ</span>
                            <h2 class="text-lg font-semibold text-gray-900">AI Answer</h2>
                        </div>
                        <p class="text-gray-800 leading-relaxed">${data.answer}</p>
                    </div>
                `;
            }

            // Source Documents
            if (data.results && data.results.length > 0) {
                html += `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">üìÑ Source Documents (${data.results.length})</h2>
                        <div class="space-y-4">
                `;

                data.results.forEach((result, index) => {
                    html += `
                        <div class="border border-gray-200 rounded-lg p-4 hover:border-purple-300 transition-colors">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-semibold text-purple-600">#${index + 1}</span>
                                    <span class="text-sm font-medium text-gray-900">${result.metadata?.filename || 'Document'}</span>
                                </div>
                                <span class="text-xs text-gray-500">Score: ${(result.score || 0).toFixed(3)}</span>
                            </div>
                            <p class="text-sm text-gray-700 leading-relaxed">${result.text}</p>
                            ${result.metadata?.page ? `<div class="mt-2 text-xs text-gray-500">Page ${result.metadata.page}</div>` : ''}
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6 text-center">
                        <p class="text-yellow-700">No results found. Try a different query.</p>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login';
        }

        // Load collections on page load
        loadCollections();
    </script>
</body>
</html>
