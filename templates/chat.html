<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - AstraFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col">
            <!-- User Section -->
            <div class="p-4 border-b border-gray-200">
                <div class="font-semibold text-gray-900 mb-1" id="userName">User</div>
                <div class="text-sm text-gray-500">Admin</div>
            </div>

            <!-- Main Navigation -->
            <nav class="p-4 space-y-1 border-b border-gray-200">
                <a href="/" class="flex items-center space-x-2 px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-50 text-sm">
                    <span>🏠</span>
                    <span>Home</span>
                </a>
                <a href="/dashboard" class="flex items-center space-x-2 px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-50 text-sm">
                    <span>📊</span>
                    <span>Dashboard</span>
                </a>
                <a href="/collections" class="flex items-center space-x-2 px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-50 text-sm">
                    <span>📚</span>
                    <span>Collections</span>
                </a>
                <a href="/workspace" class="flex items-center space-x-2 px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-50 text-sm">
                    <span>💼</span>
                    <span>Workspace</span>
                </a>
                <a href="/chat" class="flex items-center space-x-2 px-3 py-2 rounded-lg bg-gray-100 text-gray-900 text-sm">
                    <span>💭</span>
                    <span>Chat</span>
                </a>
                <a href="/workflows" class="flex items-center space-x-2 px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-50 text-sm">
                    <span>⚙️</span>
                    <span>Workflows</span>
                </a>
                <a href="/stocks" class="flex items-center space-x-2 px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-50 text-sm">
                    <span>📈</span>
                    <span>Stocks</span>
                </a>
            </nav>

            <div class="flex-1"></div>

            <!-- Settings & Date -->
            <div class="p-4 border-t border-gray-200">
                <a href="/settings" class="flex items-center space-x-2 px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-50 text-sm mb-2">
                    <span>⚙️</span>
                    <span>Settings</span>
                </a>
                <div class="text-xs text-gray-500 px-3" id="sidebarDate"></div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col">
            <!-- Header -->
            <div class="bg-white border-b border-gray-200 p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">💬 AI Chat</h1>
                        <p class="text-sm text-gray-500">Chat with AI models (GPT-4, Gemini)</p>
                    </div>
                    <button onclick="showNewChatModal()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm font-medium">
                        + New Chat
                    </button>
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4">
            </div>

            <!-- Input Area -->
            <div class="bg-white border-t border-gray-200 p-4">
                <div class="max-w-4xl mx-auto">
                    <div class="flex gap-2 items-center">
                        <select id="activeModelSelect" onchange="changeModel()" class="px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm bg-white cursor-pointer min-w-[140px]">
                            <option value="gpt-4">GPT-4</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            <option value="gemini-pro">Gemini Pro</option>
                            <option value="claude-3">Claude 3</option>
                            <option value="llama-2">Llama 2</option>
                        </select>
                        <input 
                            type="text" 
                            id="messageInput" 
                            placeholder="Type your message..." 
                            class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            onkeypress="if(event.key === 'Enter') sendMessage()"
                        />
                        <button 
                            onclick="sendMessage()" 
                            id="sendButton"
                            class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium disabled:bg-gray-300 disabled:cursor-not-allowed"
                        >
                            Send
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- New Chat Modal -->
    <div id="newChatModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Start New Chat</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">AI Model</label>
                    <select id="modelSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="gpt-4">GPT-4 (OpenAI)</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo (OpenAI)</option>
                        <option value="gemini-pro">Gemini Pro (Google)</option>
                        <option value="claude-3">Claude 3 (Anthropic)</option>
                        <option value="llama-2">Llama 2 (Meta)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Collection (Optional)</label>
                    <select id="collectionSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">None (General chat)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Select a collection to chat about your documents</p>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="createChatSession()" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium">
                        Start Chat
                    </button>
                    <button onclick="hideNewChatModal()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Set current date
        const currentDate = new Date();
        const dateStr = currentDate.toLocaleDateString('en-US', { 
            weekday: 'short', 
            month: 'short', 
            day: 'numeric' 
        });
        document.getElementById('sidebarDate').textContent = dateStr;

        let currentSessionId = null;
        let currentModel = null;
        let collections = [];

        async function loadCollections() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('http://localhost:8000/collections', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                collections = await response.json();
                
                const select = document.getElementById('collectionSelect');
                select.innerHTML = '<option value="">None (General chat)</option>' +
                    collections.map(col => `<option value="${col.id}">${col.name}</option>`).join('');
            } catch (error) {
                console.error('Error loading collections:', error);
            }
        }

        function showNewChatModal() {
            document.getElementById('newChatModal').classList.remove('hidden');
        }

        function hideNewChatModal() {
            document.getElementById('newChatModal').classList.add('hidden');
        }

        async function createChatSession() {
            const model = document.getElementById('modelSelect').value;
            const collectionId = document.getElementById('collectionSelect').value || null;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('http://localhost:8000/chat/sessions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ model, collection_id: collectionId })
                });

                const session = await response.json();
                currentSessionId = session.id;
                currentModel = model;
                
                // Update model selector value (it's always enabled now)
                document.getElementById('activeModelSelect').value = model;
                
                // Clear messages and show welcome message
                document.getElementById('chatMessages').innerHTML = '';
                
                // Get user name from the page
                const userName = document.getElementById('userName').textContent || 'there';
                addMessageToUI('assistant', `Hi, ${userName}! How can I help you today?`);
                
                hideNewChatModal();
                document.getElementById('messageInput').focus();
            } catch (error) {
                console.error('Error creating chat session:', error);
                alert('Error creating chat session');
            }
        }

        async function sendMessage() {
            if (!currentSessionId) {
                alert('Please start a chat session first');
                return;
            }

            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content) return;

            // Add user message to UI
            addMessageToUI('user', content);
            input.value = '';

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`http://localhost:8000/chat/sessions/${currentSessionId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content })
                });

                const message = await response.json();
                
                // TODO: Get AI response from agent_router service
                // For now, show a placeholder
                setTimeout(() => {
                    addMessageToUI('assistant', 'AI response will be implemented when agent_router service is connected.');
                }, 500);

            } catch (error) {
                console.error('Error sending message:', error);
                addMessageToUI('system', 'Error sending message. Please try again.');
            }
        }

        function addMessageToUI(role, content) {
            const container = document.getElementById('chatMessages');
            
            // Remove empty state if present
            if (container.querySelector('.text-center')) {
                container.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex gap-3';

            if (role === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex-1"></div>
                    <div class="max-w-2xl">
                        <div class="bg-purple-600 text-white rounded-lg p-4">
                            <p class="text-sm">${content}</p>
                        </div>
                    </div>
                    <div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center text-white text-sm font-semibold flex-shrink-0">
                        U
                    </div>
                `;
            } else if (role === 'assistant') {
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white text-sm flex-shrink-0">
                        🤖
                    </div>
                    <div class="max-w-2xl">
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <p class="text-sm text-gray-800">${content}</p>
                        </div>
                    </div>
                    <div class="flex-1"></div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="flex-1"></div>
                    <div class="max-w-2xl">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <p class="text-sm text-yellow-800">${content}</p>
                        </div>
                    </div>
                    <div class="flex-1"></div>
                `;
            }

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        async function changeModel() {
            if (!currentSessionId) return;
            
            const newModel = document.getElementById('activeModelSelect').value;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`http://localhost:8000/api/chat/sessions/${currentSessionId}/model`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ model: newModel })
                });

                if (response.ok) {
                    currentModel = newModel;
                    addMessageToUI('system', `Model changed to ${newModel}`);
                    logger.info(`Model changed to ${newModel}`);
                } else {
                    alert('Failed to change model');
                    // Revert dropdown
                    document.getElementById('activeModelSelect').value = currentModel;
                }
            } catch (error) {
                console.error('Error changing model:', error);
                alert('Error changing model');
                // Revert dropdown
                document.getElementById('activeModelSelect').value = currentModel;
            }
        }

        // Show welcome message on page load
        function showWelcomeMessage() {
            const userName = document.getElementById('userName').textContent || 'there';
            addMessageToUI('assistant', `Hi, ${userName}! How can I help you today?`);
        }

        // Load collections and show welcome message on page load
        loadCollections();
        showWelcomeMessage();
    </script>
</body>
</html>
